title: Configure the server

steps:
  - title: Activate apache modules
    class: is-apache
    code: |
      ```sh
      a2enmod rewrite
      a2enmod ssl
      ```

  - title: Configure the http to https and www redirections
    class: is-apache
    code: |
      Edit the file `/etc/apache2/sites-available/default.conf`

      ```ApacheConf
      ServerName localhost

      <VirtualHost *:80>
        RewriteEngine on
        RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,QSA,R=permanent]
      </VirtualHost>

      <VirtualHost *:443>
        RewriteEngine on
        RewriteCond %{HTTP_HOST} ^www\.(.+) [NC]
        RewriteRule ^ http://%1%{REQUEST_URI} [L,R=301]

        # SSL
        SSLEngine On
        SSLCertificateFile /etc/letsencrypt/live/example.com/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/example.com/privkey.pem
      </VirtualHost>
      ```

  - title: Configure the site
    class: is-apache
    code: |
      Edit the file `/etc/apache2/sites-available/example.com.conf`

      ```ApacheConf
      <VirtualHost *:443>
        # Server name
        ServerName example.com
        ServerAdmin webmaster@localhost

        # Document root
        DocumentRoot /var/www/example.com/www

        # Logs
        ErrorLog /var/www/example.com/logs/apache.error
        CustomLog /var/www/example.com/logs/apache.log combined

        # Directory configuration
        <Directory /var/www/example.com/www>
          AllowOverride All
          Require all granted
        </Directory>
        
        # User
        AssignUserId example example

        # SSL
        SSLEngine On
        SSLCertificateFile /etc/letsencrypt/live/example.com/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/example.com/privkey.pem
      </VirtualHost>
      ```

  - title: Enable Http/2 protocol
    class: is-apache is-optional
    code: |
      ```sh
      add-apt-repository -y ppa:ondrej/apache2
      apt-get update
      apt-get dist-upgrade
      a2enmod http2
      ```
      To activate it, edit `001-example.com.conf` adding the following line in the virtualhost:

      ```ApacheConf
      Protocols h2 http/1.1
      ```
      
  - title: Activate the site
    class: is-apache
    code: |
      ```sh
      ln -s /etc/apache2/sites-available/example.com.conf /etc/apache2/sites-enabled/001-example.com.conf
      service apache2 restart
      ```
